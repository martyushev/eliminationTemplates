function [C,U,dU] = coefs_p4p_fr(data)

    M1 = data{1};
    M2 = data{2};
    M3 = data{3};

    C = zeros(4,20);

    C(25) = M1(1)*M2(1)+M1(2)*M2(2)+M1(3)*M2(3)+M1(4)*M2(4);
    C(26) = M1(1)*M3(1)+M1(2)*M3(2)+M1(3)*M3(3)+M1(4)*M3(4);
    C(2) = M1(1)*M3(13)+M1(2)*M3(14)+M1(3)*M3(15)+M1(4)*M3(16);
    C(57) = M1(5)*M2(5)+M1(6)*M2(6)+M1(7)*M2(7)+M1(8)*M2(8);
    C(58) = M1(5)*M3(5)+M1(6)*M3(6)+M1(7)*M3(7)+M1(8)*M3(8);
    C(22) = M1(5)*M3(17)+M1(6)*M3(18)+M1(7)*M3(19)+M1(8)*M3(20);
    C(41) = M1(9)*M2(9)+M1(10)*M2(10)+M1(11)*M2(11)+M1(12)*M2(12);
    C(42) = M1(9)*M3(9)+M1(10)*M3(10)+M1(11)*M3(11)+M1(12)*M3(12);
    C(10) = M1(9)*M3(21)+M1(10)*M3(22)+M1(11)*M3(23)+M1(12)*M3(24);
    C(77) = M1(13)*M2(13)+M1(14)*M2(14)+M1(15)*M2(15)+M1(16)*M2(16);
    C(66) = M1(13)*M3(25)+M1(14)*M3(26)+M1(15)*M3(27)+M1(16)*M3(28);
    C(78) = M1(13)*M3(29)+M1(14)*M3(30)+M1(15)*M3(31)+M1(16)*M3(32);
    C(27) = M2(1)*M3(1)+M2(2)*M3(2)+M2(3)*M3(3)+M2(4)*M3(4);
    C(3) = M2(1)*M3(13)+M2(2)*M3(14)+M2(3)*M3(15)+M2(4)*M3(16);
    C(59) = M2(5)*M3(5)+M2(6)*M3(6)+M2(7)*M3(7)+M2(8)*M3(8);
    C(23) = M2(5)*M3(17)+M2(6)*M3(18)+M2(7)*M3(19)+M2(8)*M3(20);
    C(43) = M2(9)*M3(9)+M2(10)*M3(10)+M2(11)*M3(11)+M2(12)*M3(12);
    C(11) = M2(9)*M3(21)+M2(10)*M3(22)+M2(11)*M3(23)+M2(12)*M3(24);
    C(67) = M2(13)*M3(25)+M2(14)*M3(26)+M2(15)*M3(27)+M2(16)*M3(28);
    C(79) = M2(13)*M3(29)+M2(14)*M3(30)+M2(15)*M3(31)+M2(16)*M3(32);
    C(28) = M1(1)^2+M1(2)^2+M1(3)^2+M1(4)^2-M2(1)^2-M2(2)^2-M2(3)^2-M2(4)^2;
    C(60) = M1(5)^2+M1(6)^2+M1(7)^2+M1(8)^2-M2(5)^2-M2(6)^2-M2(7)^2-M2(8)^2;
    C(44) = M1(9)^2+M1(10)^2+M1(11)^2+M1(12)^2-M2(9)^2-M2(10)^2-M2(11)^2-M2(12)^2;
    C(80) = M1(13)^2+M1(14)^2+M1(15)^2+M1(16)^2-M2(13)^2-M2(14)^2-M2(15)^2-M2(16)^2;
    C(48) = 2*M1(1)*M1(5)+2*M1(2)*M1(6)+2*M1(3)*M1(7)+2*M1(4)*M1(8)-2*M2(1)*M2(5)-2*M2(2)*M2(6)-2*M2(3)*M2(7)-2*M2(4)*M2(8);
    C(36) = 2*M1(1)*M1(9)+2*M1(2)*M1(10)+2*M1(3)*M1(11)+2*M1(4)*M1(12)-2*M2(1)*M2(9)-2*M2(2)*M2(10)-2*M2(3)*M2(11)-2*M2(4)*M2(12);
    C(64) = 2*M1(1)*M1(13)+2*M1(2)*M1(14)+2*M1(3)*M1(15)+2*M1(4)*M1(16)-2*M2(1)*M2(13)-2*M2(2)*M2(14)-2*M2(3)*M2(15)-2*M2(4)*M2(16);
    C(45) = M1(1)*M2(5)+M1(5)*M2(1)+M1(2)*M2(6)+M1(6)*M2(2)+M1(3)*M2(7)+M1(7)*M2(3)+M1(4)*M2(8)+M1(8)*M2(4);
    C(33) = M1(1)*M2(9)+M1(9)*M2(1)+M1(2)*M2(10)+M1(10)*M2(2)+M1(3)*M2(11)+M1(11)*M2(3)+M1(4)*M2(12)+M1(12)*M2(4);
    C(61) = M1(1)*M2(13)+M1(13)*M2(1)+M1(2)*M2(14)+M1(14)*M2(2)+M1(3)*M2(15)+M1(15)*M2(3)+M1(4)*M2(16)+M1(16)*M2(4);
    C(46) = M1(1)*M3(5)+M1(5)*M3(1)+M1(2)*M3(6)+M1(6)*M3(2)+M1(3)*M3(7)+M1(7)*M3(3)+M1(4)*M3(8)+M1(8)*M3(4);
    C(34) = M1(1)*M3(9)+M1(9)*M3(1)+M1(2)*M3(10)+M1(10)*M3(2)+M1(3)*M3(11)+M1(11)*M3(3)+M1(4)*M3(12)+M1(12)*M3(4);
    C(14) = M1(1)*M3(17)+M1(5)*M3(13)+M1(2)*M3(18)+M1(6)*M3(14)+M1(3)*M3(19)+M1(7)*M3(15)+M1(4)*M3(20)+M1(8)*M3(16);
    C(6) = M1(1)*M3(21)+M1(9)*M3(13)+M1(2)*M3(22)+M1(10)*M3(14)+M1(3)*M3(23)+M1(11)*M3(15)+M1(4)*M3(24)+M1(12)*M3(16);
    C(30) = M1(1)*M3(25)+M1(13)*M3(13)+M1(2)*M3(26)+M1(14)*M3(14)+M1(3)*M3(27)+M1(15)*M3(15)+M1(4)*M3(28)+M1(16)*M3(16);
    C(62) = M1(1)*M3(29)+M1(13)*M3(1)+M1(2)*M3(30)+M1(14)*M3(2)+M1(3)*M3(31)+M1(15)*M3(3)+M1(4)*M3(32)+M1(16)*M3(4);
    C(56) = 2*M1(5)*M1(9)+2*M1(6)*M1(10)+2*M1(7)*M1(11)+2*M1(8)*M1(12)-2*M2(5)*M2(9)-2*M2(6)*M2(10)-2*M2(7)*M2(11)-2*M2(8)*M2(12);
    C(76) = 2*M1(5)*M1(13)+2*M1(6)*M1(14)+2*M1(7)*M1(15)+2*M1(8)*M1(16)-2*M2(5)*M2(13)-2*M2(6)*M2(14)-2*M2(7)*M2(15)-2*M2(8)*M2(16);
    C(53) = M1(5)*M2(9)+M1(9)*M2(5)+M1(6)*M2(10)+M1(10)*M2(6)+M1(7)*M2(11)+M1(11)*M2(7)+M1(8)*M2(12)+M1(12)*M2(8);
    C(73) = M1(5)*M2(13)+M1(13)*M2(5)+M1(6)*M2(14)+M1(14)*M2(6)+M1(7)*M2(15)+M1(15)*M2(7)+M1(8)*M2(16)+M1(16)*M2(8);
    C(54) = M1(5)*M3(9)+M1(9)*M3(5)+M1(6)*M3(10)+M1(10)*M3(6)+M1(7)*M3(11)+M1(11)*M3(7)+M1(8)*M3(12)+M1(12)*M3(8);
    C(18) = M1(5)*M3(21)+M1(9)*M3(17)+M1(6)*M3(22)+M1(10)*M3(18)+M1(7)*M3(23)+M1(11)*M3(19)+M1(8)*M3(24)+M1(12)*M3(20);
    C(50) = M1(5)*M3(25)+M1(13)*M3(17)+M1(6)*M3(26)+M1(14)*M3(18)+M1(7)*M3(27)+M1(15)*M3(19)+M1(8)*M3(28)+M1(16)*M3(20);
    C(74) = M1(5)*M3(29)+M1(13)*M3(5)+M1(6)*M3(30)+M1(14)*M3(6)+M1(7)*M3(31)+M1(15)*M3(7)+M1(8)*M3(32)+M1(16)*M3(8);
    C(72) = 2*M1(9)*M1(13)+2*M1(10)*M1(14)+2*M1(11)*M1(15)+2*M1(12)*M1(16)-2*M2(9)*M2(13)-2*M2(10)*M2(14)-2*M2(11)*M2(15)-2*M2(12)*M2(16);
    C(69) = M1(9)*M2(13)+M1(13)*M2(9)+M1(10)*M2(14)+M1(14)*M2(10)+M1(11)*M2(15)+M1(15)*M2(11)+M1(12)*M2(16)+M1(16)*M2(12);
    C(38) = M1(9)*M3(25)+M1(13)*M3(21)+M1(10)*M3(26)+M1(14)*M3(22)+M1(11)*M3(27)+M1(15)*M3(23)+M1(12)*M3(28)+M1(16)*M3(24);
    C(70) = M1(9)*M3(29)+M1(13)*M3(9)+M1(10)*M3(30)+M1(14)*M3(10)+M1(11)*M3(31)+M1(15)*M3(11)+M1(12)*M3(32)+M1(16)*M3(12);
    C(47) = M2(1)*M3(5)+M2(5)*M3(1)+M2(2)*M3(6)+M2(6)*M3(2)+M2(3)*M3(7)+M2(7)*M3(3)+M2(4)*M3(8)+M2(8)*M3(4);
    C(35) = M2(1)*M3(9)+M2(9)*M3(1)+M2(2)*M3(10)+M2(10)*M3(2)+M2(3)*M3(11)+M2(11)*M3(3)+M2(4)*M3(12)+M2(12)*M3(4);
    C(15) = M2(1)*M3(17)+M2(5)*M3(13)+M2(2)*M3(18)+M2(6)*M3(14)+M2(3)*M3(19)+M2(7)*M3(15)+M2(4)*M3(20)+M2(8)*M3(16);
    C(7) = M2(1)*M3(21)+M2(9)*M3(13)+M2(2)*M3(22)+M2(10)*M3(14)+M2(3)*M3(23)+M2(11)*M3(15)+M2(4)*M3(24)+M2(12)*M3(16);
    C(31) = M2(1)*M3(25)+M2(13)*M3(13)+M2(2)*M3(26)+M2(14)*M3(14)+M2(3)*M3(27)+M2(15)*M3(15)+M2(4)*M3(28)+M2(16)*M3(16);
    C(63) = M2(1)*M3(29)+M2(13)*M3(1)+M2(2)*M3(30)+M2(14)*M3(2)+M2(3)*M3(31)+M2(15)*M3(3)+M2(4)*M3(32)+M2(16)*M3(4);
    C(55) = M2(5)*M3(9)+M2(9)*M3(5)+M2(6)*M3(10)+M2(10)*M3(6)+M2(7)*M3(11)+M2(11)*M3(7)+M2(8)*M3(12)+M2(12)*M3(8);
    C(19) = M2(5)*M3(21)+M2(9)*M3(17)+M2(6)*M3(22)+M2(10)*M3(18)+M2(7)*M3(23)+M2(11)*M3(19)+M2(8)*M3(24)+M2(12)*M3(20);
    C(51) = M2(5)*M3(25)+M2(13)*M3(17)+M2(6)*M3(26)+M2(14)*M3(18)+M2(7)*M3(27)+M2(15)*M3(19)+M2(8)*M3(28)+M2(16)*M3(20);
    C(75) = M2(5)*M3(29)+M2(13)*M3(5)+M2(6)*M3(30)+M2(14)*M3(6)+M2(7)*M3(31)+M2(15)*M3(7)+M2(8)*M3(32)+M2(16)*M3(8);
    C(39) = M2(9)*M3(25)+M2(13)*M3(21)+M2(10)*M3(26)+M2(14)*M3(22)+M2(11)*M3(27)+M2(15)*M3(23)+M2(12)*M3(28)+M2(16)*M3(24);
    C(71) = M2(9)*M3(29)+M2(13)*M3(9)+M2(10)*M3(30)+M2(14)*M3(10)+M2(11)*M3(31)+M2(15)*M3(11)+M2(12)*M3(32)+M2(16)*M3(12);

    C = C./repmat(sqrt(sum(C.*conj(C),2)),1,size(C,2));

    U = @(S,n)[S(1,:).^2.*S(2,:);S(1,:).*S(2,:).*S(3,:);S(3,:).^2.*S(2,:);S(1,:).*S(2,:).*S(4,:);S(4,:).*S(3,:).*S(2,:);S(4,:).^2.*S(2,:);S(1,:).^2;S(2,:).*S(1,:);S(3,:).*S(1,:);S(2,:).*S(3,:);S(3,:).^2;S(4,:).*S(1,:);S(2,:).*S(4,:);S(3,:).*S(4,:);S(4,:).^2;S(1,:);S(2,:);S(3,:);S(4,:);ones(1,n)];
    dU = @(S,n)[[2.*S(2,:).*S(1,:);S(2,:).*S(3,:);zeros(1,n);S(2,:).*S(4,:);zeros(1,n);zeros(1,n);2.*S(1,:);S(2,:);S(3,:);zeros(1,n);zeros(1,n);S(4,:);zeros(1,n);zeros(1,n);zeros(1,n);ones(1,n);zeros(1,n);zeros(1,n);zeros(1,n);zeros(1,n)],[S(1,:).^2;S(3,:).*S(1,:);S(3,:).^2;S(4,:).*S(1,:);S(3,:).*S(4,:);S(4,:).^2;zeros(1,n);S(1,:);zeros(1,n);S(3,:);zeros(1,n);zeros(1,n);S(4,:);zeros(1,n);zeros(1,n);zeros(1,n);ones(1,n);zeros(1,n);zeros(1,n);zeros(1,n)],[zeros(1,n);S(2,:).*S(1,:);2.*S(2,:).*S(3,:);zeros(1,n);S(2,:).*S(4,:);zeros(1,n);zeros(1,n);zeros(1,n);S(1,:);S(2,:);2.*S(3,:);zeros(1,n);zeros(1,n);S(4,:);zeros(1,n);zeros(1,n);zeros(1,n);ones(1,n);zeros(1,n);zeros(1,n)],[zeros(1,n);zeros(1,n);zeros(1,n);S(2,:).*S(1,:);S(2,:).*S(3,:);2.*S(2,:).*S(4,:);zeros(1,n);zeros(1,n);zeros(1,n);zeros(1,n);zeros(1,n);S(1,:);S(2,:);S(3,:);2.*S(4,:);zeros(1,n);zeros(1,n);zeros(1,n);ones(1,n);zeros(1,n)]];

end